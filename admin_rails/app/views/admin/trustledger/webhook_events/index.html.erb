<%= render "admin/trustledger/nav" %>

<h1>Webhook イベント一覧</h1>

<form method="get" style="margin-bottom: 16px;">
  <label>開始日:
    <input type="text" name="from" placeholder="YYYY-MM-DD" value="<%= params[:from] %>" />
  </label>

  <label style="margin-left: 12px;">終了日:
    <input type="text" name="to" placeholder="YYYY-MM-DD" value="<%= params[:to] %>" />
  </label>

  <label style="margin-left: 12px;">イベント種別:
    <input type="text" name="event_type" value="<%= params[:event_type] %>" />
  </label>

  <label style="margin-left: 12px;">状態:
    <input type="text" name="status" value="<%= params[:status] %>" />
  </label>

  <label style="margin-left: 12px;">件数:
    <input type="number" name="per_page" value="<%= params[:per_page].presence || 50 %>" style="width: 90px;" />
  </label>

  <button type="submit" style="margin-left: 12px;">検索</button>
</form>

<% if @error.present? %>
  <h2 style="color:red;">エラー</h2>
  <pre><%= JSON.pretty_generate(@error) %></pre>
<% else %>

<% def jp_event_type(t) %>
  <% return "-" if t.nil? %>
  <% s = t.to_s %>

  <% return "決済 作成" if s == "payment_intent.created" %>
  <% return "決済 完了（成功）" if s == "payment_intent.succeeded" %>

  <% return "課金 完了（成功）" if s == "charge.succeeded" %>
  <% return "課金 更新" if s == "charge.updated" %>
  <% return "課金 返金完了（成功）" if s == "charge.refunded" %>
  <% return "返金 更新" if s == "charge.refund.updated" %>

  <% return "返金 作成" if s == "refund.created" %>
  <% return "返金 更新" if s == "refund.updated" %>

  <% return "残高 更新" if s == "balance.available" %>

  <%= s %>
<% end %>


  <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>受信時刻</th>
        <th>状態</th>
        <th>イベント種別</th>
        <th>イベントID</th>
        <th>payment_id</th>
        <th>order_id</th>
        <th>エラー</th>
      </tr>
    </thead>
    <tbody>
      <% @items.each do |e| %>
        <tr>
          <td><%= e["created_at"] %></td>
          <td><%= e["status"] %></td>
          <td>
            <div><%= jp_event_type(e["event_type"]) %></div>
          <div style="color:#666; font-size:12px;"><%= e["event_type"] %></div>
            </td>
          <td style="font-family: monospace;">
            <a href="/admin/trustledger/webhook-events/<%= e["event_id"] %>"><%= e["event_id"] %></a>
          </td>
          <td>
            <% if e["payment_id"] %>
              <a href="/admin/trustledger/postings?payment_id=<%= e["payment_id"] %>"><%= e["payment_id"] %></a>
            <% else %>
              -
            <% end %>
          </td>
          <td>
            <% if e["order_id"] %>
              <a href="/admin/trustledger/postings?order_id=<%= e["order_id"] %>"><%= e["order_id"] %></a>
            <% else %>
              -
            <% end %>
          </td>
          <td><%= e["error_message"] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div style="margin-top: 12px;">
    <% base_params = request.query_parameters.except("nav", "next_cursor", "cursor") %>

    <% if @stack_size.to_i > 0 %>
      <% newer_params = base_params.merge("nav" => "newer") %>
      <a href="<%= url_for(newer_params) %>">新しい方へ</a>
      <span style="margin: 0 10px;">|</span>
    <% end %>

    <% if @next_cursor.present? %>
      <% older_params = base_params.merge("nav" => "older", "next_cursor" => @next_cursor) %>
      <a href="<%= url_for(older_params) %>">古い方へ</a>
      <span style="color:#666;">(cursor=<%= @next_cursor %>)</span>
    <% end %>
  </div>
<% end %>