<%= render "admin/trustledger/nav" %>

<h1>Webhook イベント詳細</h1>

<p>
  <a href="/admin/trustledger/webhook-events">← Webhook一覧へ戻る</a>
</p>

<% if flash[:notice].present? %>
  <div style="border:1px solid #2d8a3a; padding:10px; margin:12px 0; background:#f3fff5;">
    <strong>成功</strong>: <%= flash[:notice] %>
  </div>
<% end %>

<% if flash[:alert].present? %>
  <div style="border:1px solid #c0392b; padding:10px; margin:12px 0; background:#fff3f3;">
    <strong>失敗</strong>: <%= flash[:alert] %>
  </div>
<% end %>

<% if @error.present? %>
  <h2 style="color:red;">エラー</h2>
  <pre><%= JSON.pretty_generate(@error) %></pre>
<% else %>

<% def jp_event_type(t) %>
  <% return "-" if t.nil? %>
  <% s = t.to_s %>

  <% return "決済 作成" if s == "payment_intent.created" %>
  <% return "決済 完了（成功）" if s == "payment_intent.succeeded" %>

  <% return "課金 完了（成功）" if s == "charge.succeeded" %>
  <% return "課金 更新" if s == "charge.updated" %>
  <% return "課金 返金完了（成功）" if s == "charge.refunded" %>
  <% return "返金 更新" if s == "charge.refund.updated" %>

  <% return "返金 作成" if s == "refund.created" %>
  <% return "返金 更新" if s == "refund.updated" %>

  <% return "残高 更新" if s == "balance.available" %>

  <%= s %>
<% end %>


  <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
    <tr><th>受信時刻</th><td><%= @data["created_at"] %></td></tr>
    <tr><th>プロバイダ</th><td><%= @data["provider"] %></td></tr>
    <tr><th>イベント種別</th><td><%= jp_event_type(@data["event_type"]) %>（<span style="color:#666;"><%= @data["event_type"] %></span>）</td></tr>
    <tr><th>イベントID</th><td style="font-family: monospace;"><%= @data["event_id"] %></td></tr>
    <tr><th>状態</th><td><%= @data["status"] %></td></tr>
    <tr><th>payment_id</th>
      <td>
        <% if @data["payment_id"] %>
          <a href="/admin/trustledger/postings?payment_id=<%= @data["payment_id"] %>"><%= @data["payment_id"] %></a>
        <% else %>-<% end %>
      </td>
    </tr>
    <tr><th>order_id</th>
      <td>
        <% if @data["order_id"] %>
          <a href="/admin/trustledger/postings?order_id=<%= @data["order_id"] %>"><%= @data["order_id"] %></a>
        <% else %>-<% end %>
      </td>
    </tr>
    <tr><th>payload_hash</th><td style="font-family: monospace;"><%= @data["payload_hash"] %></td></tr>
    <tr><th>エラー</th><td><%= @data["error_message"] %></td></tr>
    <tr><th>更新時刻</th><td><%= @data["updated_at"] %></td></tr>
  </table>

  <% if @data["payload_is_null"] %>
    <div style="border:1px solid #c0392b; padding:10px; margin:12px 0; background:#fff3f3;">
      Replay 無効：このイベントは payload が保存されていないため再処理できません（旧イベント）。
    </div>
  <% else %>
    <form method="post" action="/admin/trustledger/webhook-events/<%= @data["event_id"] %>/replay" style="margin: 12px 0;">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <button type="submit">Replay（再処理）</button>
    </form>
  <% end %>

  <h2 style="margin-top: 16px;">処理状況（冪等）</h2>
  <% if @data["processed"].present? %>
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
      <tr><th>processed_at</th><td><%= @data["processed"]["processed_at"] %></td></tr>
      <tr><th>status</th><td><%= @data["processed"]["status"] %></td></tr>
      <tr><th>error_code</th><td><%= @data["processed"]["error_code"] %></td></tr>
      <tr><th>error_message</th><td><%= @data["processed"]["error_message"] %></td></tr>
    </table>
  <% else %>
    <p>処理レコードなし</p>
  <% end %>

  <details style="margin-top: 16px;">
    <summary>Raw JSON（監査用）</summary>
    <pre><%= JSON.pretty_generate(@data) %></pre>
  </details>
<% end %>