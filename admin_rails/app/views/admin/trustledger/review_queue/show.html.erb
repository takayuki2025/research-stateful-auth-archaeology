<%= render "admin/trustledger/nav" %>

<h1>Review Queue Item</h1>

<% if @error %>
  <div style="padding:12px; border:1px solid #f00; margin:12px 0;">
    <strong>API Error</strong><br>
    status: <%= @error.status %><br>
    <pre style="white-space:pre-wrap;"><%= @error.body %></pre>
  </div>
<% end %>

<% if @item %>
  <p><a href="/admin/dashboard/trustledger/review-queue" style="text-decoration:none;">← Back to List</a></p>

  <table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%; max-width:800px;">
    <tr style="background:#f1f5f9;"><th>ID</th><td><%= @item["id"] %></td></tr>
    <tr><th>queue_type</th><td><strong><%= @item["queue_type"] %></strong></td></tr>
    <tr><th>ref</th><td><%= @item["ref_type"] %>#<%= @item["ref_id"] %></td></tr>
    <tr><th>status</th><td><%= @item["status"] %></td></tr>
    <tr><th>priority</th><td><%= @item["priority"] %></td></tr>
    <tr><th>decided_action</th><td><%= @item["decided_action"] %></td></tr>
    <tr><th>decided_at</th><td><%= @item["decided_at"] %></td></tr>
    <tr><th>note</th><td><%= @item["note"] %></td></tr>
  </table>

  <h2 style="margin-top:24px; color:#1e293b;">Summary (Proposed Changes)</h2>
  <pre style="white-space:pre-wrap; background:#f8fafc; border:1px solid #e2e8f0; padding:12px; font-size:13px;"><%= JSON.pretty_generate(@item["summary"] || {}) %></pre>


  <% if @diff %>
  <h2 style="margin-top:24px; color:#0f172a;">Diff Summary</h2>
  <div style="font-size:12px; color:#64748b; margin-bottom:8px;">
    <strong>Before ID:</strong> <%= @diff["before_document_id"] %> /
    <strong>After ID:</strong> <%= @diff["after_document_id"] %> /
    <strong>Created At:</strong> <%= @diff["created_at"] %>
  </div>

  <% diff_json = @diff["diff_summary_json"] %>
  <% parsed = nil %>
  <% begin %>
    <% parsed = diff_json.is_a?(String) ? JSON.parse(diff_json) : diff_json %>
  <% rescue %>
    <% parsed = diff_json %>
  <% end %>
  <% parsed ||= {} %>

  <% before_lines = parsed["before_line_count"] %>
  <% after_lines  = parsed["after_line_count"] %>

  <div style="padding:10px 12px; background:#f8fafc; border:1px solid #e2e8f0; font-size:13px;">
    <div><strong>Line Count:</strong> before=<%= before_lines %> / after=<%= after_lines %></div>
    <% if parsed["summary"] %>
      <div style="margin-top:6px;"><strong>Summary:</strong> <%= parsed["summary"] %></div>
    <% end %>
  </div>

  <details style="margin-top:10px;">
    <summary>Show heads (before_head / after_head)</summary>
    <pre style="white-space:pre-wrap; background:#f1f5f9; border:1px solid #cbd5e1; padding:12px; font-family: monospace; font-size: 13px; max-height:360px; overflow:auto;"><%= JSON.pretty_generate({
      "before_head" => parsed["before_head"],
      "after_head"  => parsed["after_head"],
    }) %></pre>
  </details>
<% end %>


  <% if @doc %>
    <h2 style="margin-top:24px; color:#2563eb; border-left:4px solid #2563eb; padding-left:12px;">Extracted Document (Evidence)</h2>
    <div style="font-size:12px; color:#64748b; margin-bottom:8px; padding: 8px; background:#eff6ff;">
      <strong>Source URL:</strong>
      <a href="<%= @doc["source_url"] %>" target="_blank" style="color:#2563eb;"><%= @doc["source_url"] %></a><br>
      <strong>Extracted At:</strong> <%= @doc["extracted_at"] %> /
      <strong>content_hash:</strong> <%= @doc["content_hash"] %>
    </div>

    <details style="margin-top:8px;">
      <summary>Show content_text</summary>
      <pre style="white-space:pre-wrap; background:#ffffff; border:1px solid #cbd5e1; padding:15px; max-height:480px; overflow:auto; font-family: monospace; font-size: 13px; line-height:1.5;"><%= @doc["content_text"] %></pre>
    </details>
  <% else %>
    <div style="margin-top:16px; padding:12px; background:#fff7ed; border:1px solid #ffedd5; color:#9a3412; font-size:13px;">
      ⚠️ 証拠ドキュメント (after_document_id) が紐付いていません。
    </div>
  <% end %>

  <!-- ✅ 最新openのみ表示 -->
  <h2 style="margin-top:32px; color:#1e293b;">Requests for Info (latest open)</h2>
  <% if @latest_open_rfi %>
    <div style="border:1px solid #ddd; padding:12px; margin:12px 0; background:#fff;">
      <div>
        <strong>ID:</strong> <%= @latest_open_rfi["id"] %> /
        <strong>status:</strong> <span style="font-weight:bold; color:#2563eb;"><%= @latest_open_rfi["status"] %></span>
      </div>
      <div><strong>requested_at:</strong> <%= @latest_open_rfi["requested_at"] %></div>
      <div style="margin-top:8px;">
        <strong>checklist</strong>
        <pre style="white-space:pre-wrap; background:#fafafa; padding:12px; font-size:12px;"><%= JSON.pretty_generate(@latest_open_rfi["checklist"] || {}) %></pre>
      </div>
    </div>
  <% else %>
    <p style="color:#666; font-style:italic;">(no open request)</p>
  <% end %>

  <hr style="margin:40px 0; border:0; border-top:1px solid #cbd5e1;">

  <h2 style="margin-top:16px; color:#1e293b;">Decide (Actions)</h2>

  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div style="flex:1; min-width:300px; padding:15px; border:1px solid #bbf7d0; background:#f0fdf4;">
      <form method="post" action="/admin/dashboard/trustledger/review-queue/<%= @item["id"] %>/decide">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <input type="hidden" name="action" value="approve">
        <strong>Approve</strong>
        <p style="font-size:12px; color:#166534;">内容を確定させ、 SoT に反映します。</p>
        <label>note:<br>
          <textarea name="note" rows="2" style="width:100%; box-sizing:border-box;"></textarea>
        </label><br>
        <button type="submit" style="margin-top:8px; background:#16a34a; color:#fff; border:none; padding:8px 16px; cursor:pointer;" onclick="return confirm('本当に承認しますか？');">Confirm Approve</button>
      </form>
    </div>

    <div style="flex:1; min-width:300px; padding:15px; border:1px solid #fecaca; background:#fef2f2;">
      <form method="post" action="/admin/dashboard/trustledger/review-queue/<%= @item["id"] %>/decide">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <input type="hidden" name="action" value="reject">
        <strong>Reject</strong>
        <p style="font-size:12px; color:#991b1b;">変更を却下し、現在の状態を維持します。</p>
        <label>note:<br>
          <textarea name="note" rows="2" style="width:100%; box-sizing:border-box;"></textarea>
        </label><br>
        <button type="submit" style="margin-top:8px; background:#dc2626; color:#fff; border:none; padding:8px 16px; cursor:pointer;" onclick="return confirm('本当に却下しますか？');">Confirm Reject</button>
      </form>
    </div>
  </div>

  <div style="margin-top:20px; padding:15px; border:1px solid #bae6fd; background:#f0f9ff;">
    <form method="post" action="/admin/dashboard/trustledger/review-queue/<%= @item["id"] %>/decide">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <input type="hidden" name="action" value="request_more_info">
      <strong>Request More Info</strong>
      <p style="font-size:12px; color:#075985;">追加の証拠が必要な場合に使用します。</p>
      <label>note:<br>
        <textarea name="note" rows="2" style="width:720px; max-width:100%;">need evidence</textarea>
      </label>

      <div style="margin-top:8px;">
        <label>extra.checklist (JSON, optional):<br>
          <textarea name="extra_checklist_json" rows="6" style="width:720px; max-width:100%; font-family:monospace;" placeholder='{"type":"providerintel","message":"...","items":[...]}'></textarea>
        </label>
      </div>

      <button type="submit" style="margin-top:12px; background:#0ea5e9; color:#fff; border:none; padding:8px 20px; cursor:pointer;">Send Request</button>
    </form>
  </div>

<% else %>
  <div style="text-align:center; padding:40px;">
    <p style="font-size:18px; color:#64748b;">Not found.</p>
    <a href="/admin/dashboard/trustledger/review-queue">Back to List</a>
  </div>
<% end %>