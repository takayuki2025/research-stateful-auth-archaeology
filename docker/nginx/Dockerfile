# --- STAGE 1: nuxt_builder (Nuxtã®ãƒ“ãƒ«ãƒ‰) ---
FROM node:22-bullseye AS nuxt_builder
# ... (æ—¢å­˜ã®ãƒ“ãƒ«ãƒ‰å‡¦ç†ã¯ãã®ã¾ã¾ã€‚ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä½œã‚‹ã®ãŒç›®çš„)
RUN npm run build

# --- STAGE 1 çµ‚äº† ---

# ----------------------------------------------------

# --- STAGE 2: Nginx Production Image ---
FROM nginx:1.21.1-alpine as stage-1

# ğŸš¨ STAGE 1ã‹ã‚‰ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚³ãƒ”ãƒ¼ ğŸš¨ (å¤‰æ›´ãªã—)
# COPY --from=nuxt_builder /app/frontend/.output/public /var/www/frontend/public

# ğŸš¨ www-dataãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (å¤‰æ›´ãªã—)
RUN deluser www-data 2>/dev/null || true && \
    delgroup www-data 2>/dev/null || true && \
    addgroup -g 82 -S www-data && \
    adduser -u 82 -D -S -G www-data www-data

# Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ (å¤‰æ›´ãªã—)
COPY nginx.conf /etc/nginx/nginx.conf
COPY default.conf /etc/nginx/conf.d/default.conf

# SSL ã‚‚åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹
COPY ssl /etc/nginx/ssl

# ğŸš¨ NginxãŒä½¿ç”¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ‰€æœ‰è€…ã‚’ www-data ã«å¤‰æ›´ (å¤‰æ›´ãªã—)
RUN mkdir -p /var/www/backend /var/www/frontend/public && \
    chown -R www-data:www-data /var/www/backend /var/www/frontend/public && \
    chown -R www-data:www-data /var/cache/nginx /var/run /var/log/nginx

# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½•ã‚‰ã‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦ã€USER rootã‚’æ˜ç¤ºã€‚
USER root

# ã‚³ãƒãƒ³ãƒ‰ã¯ãã®ã¾ã¾ (å¤‰æ›´ãªã—)
ENTRYPOINT ["/usr/sbin/nginx", "-g", "daemon off;"]