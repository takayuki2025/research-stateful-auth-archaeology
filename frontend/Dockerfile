# ----------------------------------------------------------------------
# 開発用 Next.js 16 + React 19 + ESM 完全対応 Dockerfile
# ----------------------------------------------------------------------
FROM node:22-bullseye

# Debian のビルドツール
RUN apt-get update && \
    apt-get install -y build-essential python3 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ----------------------------------------------------------
# 1. package.json だけコピー（最重要）
#    → 古い package-lock.json は絶対に使わない
# ----------------------------------------------------------
COPY package.json ./

# ----------------------------------------------------------
# 2. Next.js 16 + React 19 の "最新 lockfile を再生成"
# ----------------------------------------------------------
RUN npm install --legacy-peer-deps

# ----------------------------------------------------------
# 3. ソースコードをコピー（依存後にコピーする）
# ----------------------------------------------------------
COPY . .

# ----------------------------------------------------------
# 4. 開発モードで実行
# ----------------------------------------------------------
CMD ["npm", "run", "dev"]