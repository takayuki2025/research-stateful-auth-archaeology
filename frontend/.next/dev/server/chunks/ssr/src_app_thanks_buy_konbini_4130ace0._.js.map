{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/app/thanks/buy/konbini/W-ThanksKonbini.module.css [app-ssr] (css module)"],"sourcesContent":["__turbopack_context__.v({\n  \"actions\": \"W-ThanksKonbini-module__fhXwUa__actions\",\n  \"backHomeLink\": \"W-ThanksKonbini-module__fhXwUa__backHomeLink\",\n  \"codeBlock\": \"W-ThanksKonbini-module__fhXwUa__codeBlock\",\n  \"konbiniInfo\": \"W-ThanksKonbini-module__fhXwUa__konbiniInfo\",\n  \"message\": \"W-ThanksKonbini-module__fhXwUa__message\",\n  \"messageBox\": \"W-ThanksKonbini-module__fhXwUa__messageBox\",\n  \"thankYouPage\": \"W-ThanksKonbini-module__fhXwUa__thankYouPage\",\n  \"title\": \"W-ThanksKonbini-module__fhXwUa__title\",\n});\n"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 17, "column": 0}, "map": {"version":3,"sources":["file:///app/src/app/thanks/buy/konbini/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport type { AxiosResponse } from \"axios\";\n\nimport { useAuth } from \"@/ui/auth/useAuth\";\nimport styles from \"./W-ThanksKonbini.module.css\";\n\n/* =======================\n   Types\n======================= */\n\ntype KonbiniStoreInfo = {\n  confirmation_number?: string;\n};\n\ntype KonbiniInstructions = {\n  expires_at?: number;\n  store?: Record<string, KonbiniStoreInfo>;\n};\n\ntype Payment = {\n  payment_id: number;\n  method: \"konbini\";\n  status: \"requires_action\" | \"succeeded\" | \"expired\";\n  instructions: KonbiniInstructions | null;\n};\n\ntype OrderDetailResponse = {\n  order_id: number;\n  order_status: string;\n  payment: Payment | null;\n};\n\nexport default function ThanksBuyKonbiniPage() {\n  const searchParams = useSearchParams();\n  const orderId = searchParams.get(\"order_id\");\n  const { apiClient } = useAuth();\n\n  const [order, setOrder] = useState<OrderDetailResponse | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const retryTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const retryCountRef = useRef(0);\n\n  const MAX_RETRY = 30;\n  const INTERVAL_MS = 1000;\n\n  /* =======================\n     Fetch with polling\n  ======================= */\n\n  useEffect(() => {\n    if (!apiClient || !orderId) {\n      setError(\"注文情報が取得できませんでした。\");\n      return;\n    }\n\n    let cancelled = false;\n\n    const fetchOrder = async () => {\n      try {\n        const res: AxiosResponse<OrderDetailResponse> = await apiClient.get(\n          `/me/orders/${orderId}`,\n        );\n\n        if (cancelled) return;\n\n        setOrder(res.data);\n\n        const payment = res.data.payment;\n\n        // polling 継続条件\n        if (\n          payment &&\n          payment.method === \"konbini\" &&\n          payment.status === \"requires_action\" &&\n          !payment.instructions &&\n          retryCountRef.current < MAX_RETRY\n        ) {\n          retryCountRef.current += 1;\n          retryTimerRef.current = setTimeout(fetchOrder, INTERVAL_MS);\n        }\n      } catch {\n        if (!cancelled) {\n          setError(\"注文情報の取得に失敗しました。\");\n        }\n      }\n    };\n\n    fetchOrder();\n\n    return () => {\n      cancelled = true;\n      if (retryTimerRef.current) {\n        clearTimeout(retryTimerRef.current);\n      }\n    };\n  }, [apiClient, orderId]);\n\n  /* =======================\n     Guards\n  ======================= */\n\n  if (error) {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <p className={styles.message}>{error}</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!order || !order.payment) {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <p className={styles.message}>支払い情報を生成中です…</p>\n        </div>\n      </div>\n    );\n  }\n\n  const payment = order.payment;\n\n  /* =======================\n     支払い完了\n  ======================= */\n\n  if (payment.status === \"succeeded\") {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <h1 className={styles.title}>お支払いが完了しました</h1>\n          <Link href=\"/mypage?page=buy\" className={styles.backHomeLink}>\n            注文履歴へ\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  /* =======================\n     支払い待ち\n  ======================= */\n\n  if (!payment.instructions) {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <p className={styles.message}>\n            支払い情報を生成中です…\n            <br />\n            数秒後に自動で反映されます。\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  const instructions = payment.instructions;\n\n  const expiresAtText = instructions.expires_at\n    ? new Date(instructions.expires_at * 1000).toLocaleString(\"ja-JP\")\n    : \"未設定\";\n\n  const confirmationNumber =\n    instructions.store &&\n    Object.values(instructions.store)[0]?.confirmation_number\n      ? Object.values(instructions.store)[0]!.confirmation_number\n      : \"未発行（後ほど表示されます）\";\n\n  const availableStores = instructions.store\n    ? Object.keys(instructions.store)\n    : [];\n\n  /* =======================\n     UI\n  ======================= */\n\n  return (\n    <div className={styles.thankYouPage}>\n      <div className={styles.messageBox}>\n        <h1 className={styles.title}>現在、コンビニ支払い待ちです。</h1>\n\n        <p className={styles.message}>\n          支払期限までに指定のコンビニでお支払いください。\n        </p>\n        <p className={styles.message}>\n          お支払い完了後、自動的に注文が確定し発送準備に入ります。\n        </p>\n\n        <div className={styles.konbiniInfo}>\n          <p>\n            <strong>支払期限：</strong>\n            {expiresAtText}\n          </p>\n\n          <p>\n            <strong>受付番号：</strong>\n            {confirmationNumber}\n          </p>\n\n          {availableStores.length > 0 && (\n            <>\n              <p>\n                <strong>利用可能なコンビニ：</strong>\n              </p>\n              <ul>\n                {availableStores.map((store) => (\n                  <li key={store}>{store}</li>\n                ))}\n              </ul>\n            </>\n          )}\n        </div>\n\n        <div className={styles.actions}>\n          <Link\n            href={`/mypage/orders/${orderId}`}\n            className={styles.backHomeLink}\n          >\n            注文履歴へ\n          </Link>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}