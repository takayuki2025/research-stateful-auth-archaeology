{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/app/thanks/buy/konbini/W-ThanksKonbini.module.css [app-client] (css module)"],"sourcesContent":["__turbopack_context__.v({\n  \"actions\": \"W-ThanksKonbini-module__fhXwUa__actions\",\n  \"backHomeLink\": \"W-ThanksKonbini-module__fhXwUa__backHomeLink\",\n  \"codeBlock\": \"W-ThanksKonbini-module__fhXwUa__codeBlock\",\n  \"konbiniInfo\": \"W-ThanksKonbini-module__fhXwUa__konbiniInfo\",\n  \"message\": \"W-ThanksKonbini-module__fhXwUa__message\",\n  \"messageBox\": \"W-ThanksKonbini-module__fhXwUa__messageBox\",\n  \"thankYouPage\": \"W-ThanksKonbini-module__fhXwUa__thankYouPage\",\n  \"title\": \"W-ThanksKonbini-module__fhXwUa__title\",\n});\n"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 17, "column": 0}, "map": {"version":3,"sources":["file:///app/src/app/thanks/buy/konbini/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport type { AxiosResponse } from \"axios\";\n\nimport { useAuth } from \"@/ui/auth/useAuth\";\nimport styles from \"./W-ThanksKonbini.module.css\";\n\n/* =======================\n   Types\n======================= */\n\ntype KonbiniStoreInfo = {\n  confirmation_number?: string;\n};\n\ntype KonbiniInstructions = {\n  expires_at?: number;\n  store?: Record<string, KonbiniStoreInfo>;\n};\n\ntype Payment = {\n  payment_id: number;\n  method: \"konbini\";\n  status: \"requires_action\" | \"succeeded\" | \"expired\";\n  instructions: KonbiniInstructions | null;\n};\n\ntype OrderDetailResponse = {\n  order_id: number;\n  order_status: string;\n  payment: Payment | null;\n};\n\nexport default function ThanksBuyKonbiniPage() {\n  const searchParams = useSearchParams();\n  const orderId = searchParams.get(\"order_id\");\n  const { apiClient } = useAuth();\n\n  const [order, setOrder] = useState<OrderDetailResponse | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const retryTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const retryCountRef = useRef(0);\n\n  const MAX_RETRY = 30;\n  const INTERVAL_MS = 1000;\n\n  /* =======================\n     Fetch with polling\n  ======================= */\n\n  useEffect(() => {\n    if (!apiClient || !orderId) {\n      setError(\"注文情報が取得できませんでした。\");\n      return;\n    }\n\n    let cancelled = false;\n\n    const fetchOrder = async () => {\n      try {\n        const res: AxiosResponse<OrderDetailResponse> = await apiClient.get(\n          `/me/orders/${orderId}`,\n        );\n\n        if (cancelled) return;\n\n        setOrder(res.data);\n\n        const payment = res.data.payment;\n\n        // polling 継続条件\n        if (\n          payment &&\n          payment.method === \"konbini\" &&\n          payment.status === \"requires_action\" &&\n          !payment.instructions &&\n          retryCountRef.current < MAX_RETRY\n        ) {\n          retryCountRef.current += 1;\n          retryTimerRef.current = setTimeout(fetchOrder, INTERVAL_MS);\n        }\n      } catch {\n        if (!cancelled) {\n          setError(\"注文情報の取得に失敗しました。\");\n        }\n      }\n    };\n\n    fetchOrder();\n\n    return () => {\n      cancelled = true;\n      if (retryTimerRef.current) {\n        clearTimeout(retryTimerRef.current);\n      }\n    };\n  }, [apiClient, orderId]);\n\n  /* =======================\n     Guards\n  ======================= */\n\n  if (error) {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <p className={styles.message}>{error}</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!order || !order.payment) {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <p className={styles.message}>支払い情報を生成中です…</p>\n        </div>\n      </div>\n    );\n  }\n\n  const payment = order.payment;\n\n  /* =======================\n     支払い完了\n  ======================= */\n\n  if (payment.status === \"succeeded\") {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <h1 className={styles.title}>お支払いが完了しました</h1>\n          <Link href=\"/mypage?page=buy\" className={styles.backHomeLink}>\n            注文履歴へ\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  /* =======================\n     支払い待ち\n  ======================= */\n\n  if (!payment.instructions) {\n    return (\n      <div className={styles.thankYouPage}>\n        <div className={styles.messageBox}>\n          <p className={styles.message}>\n            支払い情報を生成中です…\n            <br />\n            数秒後に自動で反映されます。\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  const instructions = payment.instructions;\n\n  const expiresAtText = instructions.expires_at\n    ? new Date(instructions.expires_at * 1000).toLocaleString(\"ja-JP\")\n    : \"未設定\";\n\n  const confirmationNumber =\n    instructions.store &&\n    Object.values(instructions.store)[0]?.confirmation_number\n      ? Object.values(instructions.store)[0]!.confirmation_number\n      : \"未発行（後ほど表示されます）\";\n\n  const availableStores = instructions.store\n    ? Object.keys(instructions.store)\n    : [];\n\n  /* =======================\n     UI\n  ======================= */\n\n  return (\n    <div className={styles.thankYouPage}>\n      <div className={styles.messageBox}>\n        <h1 className={styles.title}>現在、コンビニ支払い待ちです。</h1>\n\n        <p className={styles.message}>\n          支払期限までに指定のコンビニでお支払いください。\n        </p>\n        <p className={styles.message}>\n          お支払い完了後、自動的に注文が確定し発送準備に入ります。\n        </p>\n\n        <div className={styles.konbiniInfo}>\n          <p>\n            <strong>支払期限：</strong>\n            {expiresAtText}\n          </p>\n\n          <p>\n            <strong>受付番号：</strong>\n            {confirmationNumber}\n          </p>\n\n          {availableStores.length > 0 && (\n            <>\n              <p>\n                <strong>利用可能なコンビニ：</strong>\n              </p>\n              <ul>\n                {availableStores.map((store) => (\n                  <li key={store}>{store}</li>\n                ))}\n              </ul>\n            </>\n          )}\n        </div>\n\n        <div className={styles.actions}>\n          <Link\n            href={`/mypage/orders/${orderId}`}\n            className={styles.backHomeLink}\n          >\n            注文履歴へ\n          </Link>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}