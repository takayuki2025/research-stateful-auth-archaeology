# version: "3.8"

services:
  # ============================================================
  # 1) Nginx (Reverse Proxy ‚Äî HTTPS„ÇíÊãÖÂΩì)
  # ============================================================
  nginx:
    build: ./docker/nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend:/var/www/backend
      # - ./backend/public:/var/www/backend/public
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      php:
        condition: service_healthy
      frontend_dev:
        condition: service_started
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.2

  # ============================================================
  # 2) PHP-FPM + Supervisor
  # ============================================================
  php:
    build: ./docker/php
    working_dir: /var/www/backend
    env_file:
    - ./backend/.env
    volumes:
    - ./backend:/var/www/backend
    command: php-fpm
    depends_on:
    - mysql
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.3
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ============================================================
  # 3) MySQL
  # ============================================================
  mysql:
    image: mysql:8.3
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: laravel_db
      MYSQL_USER: laravel_user
      MYSQL_PASSWORD: laravel_pass
      TZ: Asia/Tokyo # üî• ËøΩÂä†: ÊòéÁ§∫ÁöÑ„Å´„Çø„Ç§„É†„Çæ„Éº„É≥„ÇíË®≠ÂÆö
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.4

  # ============================================================
  # 4) phpMyAdmin
  # ============================================================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    platform: linux/amd64
    environment:
      PMA_ARBITRARY: 1
      PMA_HOST: 172.22.0.4
      PMA_USER: laravel_user
      PMA_PASSWORD: laravel_pass
    depends_on:
      - mysql
    ports:
      - "8080:80"
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.5

  # ============================================================
  # 5) MailHog
  # ============================================================
  mailhog:
    image: mailhog/mailhog:latest
    platform: linux/amd64
    restart: always
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.6

  # ============================================================
  # 6) Next.jsÔºàHTTPS„ÅØ‰Ωø„Çè„Å™„ÅÑ ‚Üí Nginx „ÅåÁµÇÁ´Ø„Åô„ÇãÔºâ
  # ============================================================
  frontend_dev:
    build:
      context: ./frontend
    container_name: frontend_dev
    working_dir: /app
    volumes:
      - ./frontend:/app
      - /app/.next
    environment:
      - NEXT_TELEMETRY_DISABLED=1
    command: npm run dev -- --port 3000 --hostname 0.0.0.0

  # üëá ‚òÖ„Åì„Çå„ÅåÊúÄÈáçË¶Å
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.7
  # ============================================================
  # 7) Python
  # ============================================================
  python_atlaskernel:
    build: ./python_batch/atlaskernel
    container_name: python_atlaskernel
    ports:
      - "8000:8000"
    working_dir: /app
    volumes:
      - ./python_batch/atlaskernel:/app
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: laravel_db
      DB_USER: laravel_user
      DB_PASS: laravel_pass
    networks:
      simulation1_network:
        ipv4_address: 172.22.0.8

# ============================================================
# Networks
# ============================================================
networks:
  simulation1_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24

# ============================================================
# Volumes
# ============================================================
volumes:
  mysql_data:
