version: "3.8"

services:
  # ============================================================
  # 1) Nginx（Reverse Proxy）
  # ============================================================
  nginx:
    build: ./docker/nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend:/var/www/backend
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      php:
        condition: service_healthy
      frontend_dev:
        condition: service_started
    networks:
      - simulation1_network

  # ============================================================
  # 2) PHP-FPM（Laravel）
  # ============================================================
  php:
    build: ./docker/php
    working_dir: /var/www/backend
    env_file:
      - ./backend/.env
    volumes:
      - ./backend:/var/www/backend
      - ./python_batch:/var/www/python_batch
    command: php-fpm
    depends_on:
      - mysql
    healthcheck:
      # ★ 実際に 9000 が LISTEN しているか確認
      test: ["CMD", "php-fpm", "-t"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - simulation1_network

  # ============================================================
  # 3) MySQL
  # ============================================================
  mysql:
    image: mysql:8.3
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: laravel_db
      MYSQL_USER: laravel_user
      MYSQL_PASSWORD: laravel_pass
      TZ: Asia/Tokyo
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - simulation1_network

  # ============================================================
  # 4) phpMyAdmin
  # ============================================================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    platform: linux/amd64
    environment:
      PMA_ARBITRARY: 1
      PMA_HOST: mysql
      PMA_USER: laravel_user
      PMA_PASSWORD: laravel_pass
    depends_on:
      - mysql
    ports:
      - "8080:80"
    networks:
      - simulation1_network

  # ============================================================
  # 5) MailHog
  # ============================================================
  mailhog:
    image: mailhog/mailhog:latest
    platform: linux/amd64
    restart: always
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - simulation1_network

  # ============================================================
  # 6) Next.js（dev）
  # ============================================================
  frontend_dev:
    build:
      context: ./frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
      - /app/.next
      - /app/node_modules
    environment:
      NEXT_TELEMETRY_DISABLED: "1"
    command: npm run dev -- --port 3000 --hostname 0.0.0.0
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - simulation1_network

  # ============================================================
  # 7) Python（AtlasKernel）
  # ============================================================
  python_atlaskernel:
    build: ./python_batch/atlaskernel
    ports:
      - "8000:8000"
    working_dir: /app
    volumes:
      - ./python_batch/atlaskernel:/app
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: laravel_db
      DB_USER: laravel_user
      DB_PASS: laravel_pass
    command: >
      uvicorn atlaskernel.server:app
      --host 0.0.0.0
      --port 8000
    networks:
      - simulation1_network

# ============================================================
# Network
# ============================================================
networks:
  simulation1_network:
    driver: bridge

# ============================================================
# Volumes
# ============================================================
volumes:
  mysql_data:
